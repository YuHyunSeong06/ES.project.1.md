## 2. 전체 시스템 블록 다이어그램 및 작동 개요

### 설계 목표

이 시스템은 **앉는 자세 인식 → 자동 잠금 → 집중 시간 관리 → 자동 해제** 과정을 자동화하는 스마트 의자 구조로,
사용자의 의지력에 의존하지 않고 ‘집중 유지’를 물리적으로 보조하는 것이 핵심 목적이다.

---

### 전체 시스템 구조 개요

```
┌──────────────────────────────┐
│          스마트 의자 시스템           │
└──────────────────────────────┘
         ▲                    ▲
         │                    │
         │ Bluetooth 통신      │
         │                    │
┌────────┴────────┐      ┌──────────────┐
│    아두이노 메인보드     │◄────►│  스마트폰 앱 (UI) │
└────────┬────────┘      └──────────────┘
         │
         ▼
┌──────────────────────────────┐
│      하드웨어 구성요소         │
├──────────────────────────────┤
│ 1️⃣ 로드셀 (앉음 감지)          │
│ 2️⃣ 서보모터 (잠금 장치 제어)    │
│ 3️⃣ 진동 모터 (햅틱 피드백)      │
│ 4️⃣ 블루투스 모듈 (HC-06)      │
│ 5️⃣ 타이머 제어 및 LED 표시     │
└──────────────────────────────┘
```

---

### 세부 구성 및 역할

| 구성 요소                  | 역할                             | 연결 핀   | 설명                        |
| ---------------------- | ------------------------------ | ------ | ------------------------- |
| **로드셀 (HX711 증폭기 사용)** | 사용자의 착석 여부 감지                  | A0     | 일정 무게 이상 감지 시 ‘착석’ 상태로 전환 |
| **서보모터**               | 잠금 장치 제어 (허벅지와 y축 거리 있는 부위 고정) | D9     | 타이머 시작 시 하강, 종료 시 상승      |
| **진동 모터**              | 집중 종료 시 햅틱 알림 제공               | D10    | 타이머 완료 시 약 2초간 진동         |
| **블루투스 모듈 (HC-06)**    | 스마트폰과 무선 통신                    | RX/TX  | 잠금 시간 설정값 및 해제 신호 송수신     |
| **LED 표시등 (상태 표시)**    | 시스템 상태 피드백                     | D2, D3 | 초록: 대기, 빨강: 잠금, 파랑: 해제 대기 |

---

### 작동 흐름 요약

1. **전원 인가 / 대기 상태**

   * LED: 초록색 점등
   * 로드셀이 무게 감지 전까지 “대기” 상태 유지

2. **착석 감지 (로드셀 > 20kg)**

   * “착석” 상태로 전환
   * 앱에 “사용자 착석 감지됨” 신호 전송

3. **앱에서 타이머 값 수신 (예: 50분)**

   * 아두이노는 해당 시간 동안 잠금 모드로 전환
   * 서보모터 하강 → 잠금바 고정
   * LED: 빨강색으로 변경

4. **집중 시간 진행 중**

   * 주기적으로 남은 시간 블루투스로 전송
   * 앱 UI에 실시간 타이머 표시

5. **타이머 종료 시**

   * 진동 모터 작동 (2초간)
   * LED: 파란색 점멸
   * 서보모터 상승 → 잠금 해제 가능 상태

6. **앱에서 해제 버튼 누름 → 완전 해제**

   * 아두이노로 해제 신호 수신
   * 서보모터 완전 복귀 → 사용자 일어날 수 있음

7. **앱에 기록 전송 및 저장**

   * ‘집중 완료 세션’으로 저장
   * 랭킹/통계 반영

---

### 설계적 특징

| 구분               | 내용                                                                |
| ---------------- | ----------------------------------------------------------------- |
| **안전성**          | 잠금 장치가 허벅지를 직접 고정하지 않고, 약간 떨어진 위치에서 y축 방향으로 지지되어 혈류 제한이나 근육 압박 없음 |
| **자유로운 스트레칭 가능** | 사용자는 다리나 허리를 일부 움직일 수 있어, 근육 긴장 완화 및 혈액순환 유지 가능                   |
| **불완전 일어서기 방지**  | 잠금 장치 위치상 ‘완전히 일어서기’는 불가능하나, 자세 조정은 허용                            |
| **자동 제어 시스템**    | 모든 작동은 로드셀 + 타이머 + 앱 통신에 의해 제어되어 수동 개입 최소화                        |
| **확장성**          | 블루투스 통신을 Wi-Fi나 BLE 모듈로 교체 시 IoT 기반 집중 관리 플랫폼으로 확장 가능             |

---
---

## 3. 하드웨어 회로 구성도 및 제어 로직

### ⚙️ 3-1. 회로 구성 개요

시스템은 **아두이노 Uno**를 중심으로 각 센서 및 액추에이터(모터, 진동기, 버튼)가 연결되어 있으며,
**전원은 5V USB 또는 어댑터**로 공급된다.

아래는 전체 회로의 구조적 연결 관계이다.

---

###  회로 연결 구조 (핀 배치표)

| 구성요소                | 연결 핀                   | 전원           | 설명                  |
| ------------------- | ---------------------- | ------------ | ------------------- |
| **로드셀 (HX711 모듈)**  | DT → D4, SCK → D5      | VCC(5V), GND | 착석 무게 감지용 센서        |
| **서보모터 (2개)**       | 신호핀 → D9, D8           | 5V, GND      | 좌/우 팔걸이 잠금바 제어      |
| **진동 모터 (햅틱 피드백)**  | D10                    | 5V, GND      | 타이머 종료 시 진동 발생      |
| **블루투스 모듈 (HC-06)** | TX → D0, RX → D1       | 5V, GND      | 앱과 통신 (시간 설정/해제 명령) |
| **LED 표시등**         | D2(녹색), D3(빨강), D6(파랑) | 5V, GND      | 시스템 상태 시각적 표시       |
| **수동 해제 버튼**        | D7                     | 풀다운 저항 포함    | 눌릴 시 잠금 해제 루틴 실행    |

---

###  전원 공급

* **입력 전원:** 5V (USB or DC 아답터)
* **서보모터 전류 요구량:** 약 1A (2개 기준)
* **HX711 및 블루투스 전류 요구량:** 100mA 미만
* **총소비 전류:** 약 1.2A
  → **5V 2A 어댑터 사용 권장**

---

###  3-2. 하드웨어 동작 흐름 요약

```
[전원 ON]
      ↓
[로드셀 감지 대기]
      ↓ (무게 > 20kg)
[착석 인식 → 앱에 신호 전송]
      ↓
[앱으로부터 잠금 시간 수신]
      ↓
[서보모터 하강 → 잠금 상태 진입]
      ↓
[타이머 작동 + LED 빨강]
      ↓
[시간 종료]
      ↓
[진동 모터 작동 (햅틱 알림)]
      ↓
[해제 버튼 입력 or 앱 명령 대기]
      ↓
[해제 명령 감지 시 → 서보모터 상승 → LED 파랑]
      ↓
[대기 모드로 복귀]
```

---

###  3-3. 제어 로직 의사코드 (Pseudo Code)

```cpp
// 시스템 초기화
setup() {
    initializeLoadCell();
    initializeServoMotors();
    initializeBluetooth();
    pinMode(vibrationMotor, OUTPUT);
    pinMode(releaseButton, INPUT_PULLUP);
    pinMode(ledGreen, OUTPUT);
    pinMode(ledRed, OUTPUT);
    pinMode(ledBlue, OUTPUT);
    
    state = "IDLE"; // 초기 상태
    digitalWrite(ledGreen, HIGH);
}

// 메인 루프
loop() {
    weight = readLoadCell();

    // 1️⃣ 착석 감지
    if (state == "IDLE" && weight > 20) {
        sendToApp("Seated");
        state = "WAIT_TIME";
        digitalWrite(ledGreen, LOW);
        digitalWrite(ledRed, HIGH);
    }

    // 2️⃣ 앱에서 잠금 시간 수신
    if (state == "WAIT_TIME" && bluetooth.available()) {
        lockTime = bluetooth.read(); // 분 단위
        startTimer(lockTime);
        lockChair(); // 서보모터 하강
        state = "LOCKED";
    }

    // 3️⃣ 잠금 중
    if (state == "LOCKED") {
        if (timerExpired()) {
            vibrationOn(2000); // 2초간 진동
            state = "UNLOCK_WAIT";
            digitalWrite(ledRed, LOW);
            digitalWrite(ledBlue, HIGH);
        }
    }

    // 4️⃣ 해제 대기 상태
    if (state == "UNLOCK_WAIT") {
        if (buttonPressed(releaseButton) || bluetooth.read() == "UNLOCK") {
            unlockChair(); // 서보모터 상승
            state = "IDLE";
            resetTimer();
            digitalWrite(ledBlue, LOW);
            digitalWrite(ledGreen, HIGH);
        }
    }
}
```

---

###  3-4. 논리적 설계 개요

| 상태                         | 입력 조건      | 출력 동작           | LED 상태 |
| -------------------------- | ---------- | --------------- | ------ |
| **대기 (IDLE)**              | 무게 < 20kg  | 모든 장치 OFF       | 초록 ON  |
| **착석 감지 (WAIT_TIME)**      | 무게 > 20kg  | 앱 신호 대기         | 빨강 ON  |
| **잠금 (LOCKED)**            | 앱에서 시간 수신  | 서보 하강, 타이머 시작   | 빨강 ON  |
| **잠금 해제 대기 (UNLOCK_WAIT)** | 타이머 종료     | 진동 발생, 해제 버튼 대기 | 파랑 ON  |
| **해제 완료 (IDLE 복귀)**        | 버튼 또는 앱 해제 | 서보 상승, 시간 초기화   | 초록 ON  |

---

### 3-5. 하드웨어 안정성 고려

| 항목               | 설명                           |
| ---------------- | ---------------------------- |
| **서보 구동 전류 보호**  | 1A 이상 출력 가능한 외부 5V 어댑터 권장    |
| **버튼 디바운스 처리**   | `delay(50)` 또는 소프트웨어 디바운싱 적용 |
| **안전 해제 우선순위**   | 긴급 해제 버튼 신호는 모든 상태보다 우선 처리   |
| **블루투스 연결 오류 시** | 기본 잠금 시간(50분)으로 자동 설정 후 진행   |
| **진동 모터 보호**     | 3초 이상 지속 진동 방지 (타이머로 제한)     |

---
